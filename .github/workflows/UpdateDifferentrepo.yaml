name: Update ConfigMap in Another Repo

on:
  workflow_dispatch:
    inputs:
      config_data:
        description: 'Enter key-value pair in the format {"key1":"value1","key2":"value2"}'
        required: true
        type: string
      configmap_path:
        description: 'Path to configmap'
        required: true
        type: string

jobs:
  update-configmap:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Survey repository
        uses: actions/checkout@v2
        with:
          repository: 'Karunakar1Reddy/survey'
          token: ${{ secrets.PAT_TOKEN }}
          ref: master

      - name: Checkout Test repository
        uses: actions/checkout@v2
        with:
          repository: 'Karunakar1Reddy/Test'
          token: ${{ secrets.PAT_TOKEN }}
          path: test-repo
          ref: main

      - name: Create a new branch
        run: |
          cd test-repo
          git checkout -b update-configmap-${{ github.run_id }}

      - name: Parse JSON input and update configmap.yaml
        run: |
          echo "Parsing input and updating configmap.yaml..."
          CONFIG_DATA='${{ github.event.inputs.config_data }}'
          CONFIGMAP_PATH='test-repo/${{ github.event.inputs.configmap_path }}'
          echo "ConfigMap Path: $CONFIGMAP_PATH"
          echo "Config Data: $CONFIG_DATA"
          # Convert JSON string to key-value pairs and update the configmap.yaml
          echo "$CONFIG_DATA" | jq -r 'to_entries | .[] | "\(.key)=\(.value)"' | while IFS= read -r line; do
            key=$(echo $line | cut -d'=' -f1)
            value=$(echo $line | cut -d'=' -f2)
            sed -i "s|^\(\s*${key}:\s*\).*|\1${value}|" $CONFIGMAP_PATH
          done
          echo "Updated ConfigMap:"
          cat $CONFIGMAP_PATH

      - name: Create a new branch and push changes
        run: |
          cd test-repo
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'
          git checkout -b update-configmap
          git add "$CONFIGMAP_PATH"
          git commit -m 'Update configmap.yml with new configuration'
          git push --set-upstream origin update-configmap
      - name: Create a pull request
        id: create_pr
        uses: peter-evans/create-pull-request@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}
          commit-message: 'Update configmap.yml with new configuration'
          branch: update-configmap
          base: master
          title: 'Update ConfigMap'
          body: 'This PR updates the configmap with new configuration.'

      - name: Post PR link to Teams channel
        run: |
          PR_URL=$(jq -r '.pull_request.html_url' < $GITHUB_EVENT_PATH)
          curl -H 'Content-Type: application/json' \
               -d "{\"text\": \"A new PR has been created: $PR_URL\"}" \
               ${{ secrets.TEAMS_WEBHOOK_URL }}
      - name: Merge PR after approval
        if: github.event.pull_request.merged == true
        run: |
          cd test-repo
          git checkout master
          git pull origin master
          git merge update-configmap
          git push origin master
